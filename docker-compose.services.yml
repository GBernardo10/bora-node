version: "3.3"

networks:
  proxy:
    external: true

services:
  postgres:
    image: postgres:11
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == manager]
    networks:
      - proxy
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PG_DATA: /var/lib/postgresql/data/pgdata
      POSTGRES_DB: ${POSTGRES_DB}
    healthcheck:
      interval: 10s
      timeout: 2s
      retries: 10
    ports:
      - 5432:5432
    volumes:
      - /var/lib/postgresql/data
  redis:
    image: redis:alpine
    networks:
      - proxy
    ports:
      - 6379:6379
  gateway:
    image: gesuvs/gateway
    environment:
      USER_SERVICE: ${USER_SERVICE}
      EVENTO_SERVICE: ${EVENTO_SERVICE}
      PAYMENT_SERVICE: ${PAYMENT_SERVICE}
      USER_PORT: ${USER_PORT}
      EVENTO_PORT: ${EVENTO_PORT}
      PAYMENT_PORT: ${PAYMENT_PORT}
    networks:
      - proxy
    # depends_on:
    #   - bora-evento
    #   - bora-user
    deploy:
      labels:
        - traefik.frontend.rule=PathPrefixStrip:/api
        - traefik.docker.network=proxy
        - traefik.port=7777
        - traefik.enable=true
  bora-user:
    image: gesuvs/user
    networks:
      - proxy
    depends_on:
      - postgres
    environment:
      HOST: ${HOST}
      USER_PORT: ${USER_PORT}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
    ports:
      - ${USER_PORT}:${USER_PORT}
    command: >
      sh -c "pm2-runtime dist/main.js"
  bora-evento:
    image: gesuvs/eventos
    networks:
      - proxy
    depends_on:
      - postgres
    environment:
      DATABASE_URL: ${DATABASE_URL}
      EVENTO_PORT: ${EVENTO_PORT}
      HOST: ${HOST}
    ports:
      - ${EVENTO_PORT}:${EVENTO_PORT}
    command: >
      sh -c "pm2-runtime index.js"
  bora-payment:
    image: gesuvs/payment
    networks:
      - proxy
    depends_on:
      - postgres
    environment:
      NODE_ENV: production
      HOST: ${HOST}
      PAY_PORT: ${PAYMENT_PORT}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - ${PAYMENT_PORT}:${PAYMENT_PORT}
    command: >
      sh -c "pm2-runtime dist/main.js"
